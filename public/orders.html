<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Previous Orders - Online Food Ordering</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
  <!-- Header / Navbar -->
  <header class="navbar">
    <div class="container nav-container">
      <a href="/index.html" class="logo">Tindi</a>
      <nav class="nav-links">
        <a href="/index.html">Menu</a>
        <a href="/cart.html">Cart <span id="cart-count">0</span></a>
        <a href="/orders.html" class="active">Orders</a>
        <a href="/profile.html">Profile</a>
      </nav>
    </div>
  </header>

  <!-- Orders Section -->
  <main class="container orders-page">
    <h1 class="page-title">Your Previous Orders</h1>
    <div id="orders-list" class="orders-list">
      <!-- Orders will be loaded here -->
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-about">
        <h3>üç¥ Tindi Bandi</h3>
        <p>Delicious food delivered to your doorstep. Fresh ingredients, quick service, and unbeatable taste!</p>
      </div>
      <div class="footer-links">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="/index.html">Home</a></li>
          <li><a href="/index.html#starters">Starters</a></li>
          <li><a href="/index.html#main-course">Main Course</a></li>
          <li><a href="/index.html#desserts">Desserts</a></li>
          <li><a href="/index.html#beverages">Beverages</a></li>
        </ul>
      </div>
      <div class="footer-contact">
        <h4>Contact Us</h4>
        <p>Email: support@tindibandi.com</p>
        <p>Phone: +91 90632 52519</p>
        <p>Location: Narasaraopet, India</p>
      </div>
      <div class="footer-social">
        <h4>Follow Us</h4>
        <a href="#">Facebook</a> |
        <a href="#">Instagram</a> |
        <a href="#">Twitter</a>
      </div>
    </div>
    <div class="footer-bottom">
      <p>¬© 2025 Tindi Bandi. All Rights Reserved.</p>
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    fetchOrders();
  });

  function fetchOrders() {
    const ordersContainer = document.getElementById('orders-list');
    const token = localStorage.getItem('token') || localStorage.getItem('tindi_jwt');
    
    if (!token) {
      ordersContainer.innerHTML = "<p>Please <a href='/login.html'>login</a> to view your orders.</p>";
      return;
    }
    
    ordersContainer.innerHTML = "Loading your orders...";
    
    fetch('/api/order/user-orders', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
      .then(res => {
        if (res.status === 401) {
          localStorage.removeItem('token');
          localStorage.removeItem('tindi_jwt');
          ordersContainer.innerHTML = "<p>Session expired. Please <a href='/login.html'>login again</a>.</p>";
          return null;
        }
        return res.json();
      })
      .then(orders => {
        if (!orders) return;
        
        if (!orders || orders.length === 0) {
          ordersContainer.innerHTML = "<p>No previous orders found. <a href='/index.html'>Start ordering!</a></p>";
          return;
        }
        
        ordersContainer.innerHTML = orders.map(order => `
          <div class="order-card">
            <p><strong>Order ID:</strong> ${order.orderId}</p>
            <p><strong>Total:</strong> ‚Çπ${order.total.toFixed(2)}</p>
            <p><strong>Status:</strong> ${order.status}</p>
            <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleDateString()}</p>
            <p><strong>Items:</strong> ${order.cart.map(i => `${i.name} x${i.qty}`).join(', ')}</p>
            <div>
              <strong>Rate your order: </strong>
              <span class="emoji-rating">
                <button onclick="rateOrder(${order.orderId}, 'üòç')">üòç</button>
                <button onclick="rateOrder(${order.orderId}, 'üòê')">üòê</button>
                <button onclick="rateOrder(${order.orderId}, 'ü§¢')">ü§¢</button>
              </span>
              ${order.rating ? `<span style="margin-left:10px;">You rated: ${order.rating}</span>` : ''}
            </div>
          </div>
        `).join('');
      })
      .catch(error => {
        console.error('Error fetching orders:', error);
        ordersContainer.innerHTML = "<p>Failed to load orders. Please try again later.</p>";
      });
  }

  function rateOrder(orderId, emoji) {
    const token = localStorage.getItem('token') || localStorage.getItem('tindi_jwt');
    
    if (!token) {
      alert('Please login to rate orders.');
      return;
    }
    
    fetch(`/api/order/${orderId}/rate`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ emoji })
    })
    .then(res => {
      if (res.status === 401) {
        alert('Session expired. Please login again.');
        window.location.href = '/login.html';
        return;
      }
      return res.json();
    })
    .then(data => {
      if (data) {
        alert("Thank you for your feedback!");
        fetchOrders();
      }
    })
    .catch(error => {
      console.error('Error rating order:', error);
      alert('Failed to submit rating. Please try again.');
    });
  }
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <div id="order-status">Order status will appear here.</div>
</body>
</html>
